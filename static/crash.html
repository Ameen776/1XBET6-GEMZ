<!-- static/crash.html -->
<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Crash â€” Ù„Ø¹Ø¨Ø© Ø§Ù„Ø·ÙŠØ§Ø±Ø©</title>
  <style>
    body{font-family: Arial, sans-serif;background:#07111a;color:#fff;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}
    .card{width:420px;background:linear-gradient(180deg,#0f1724,#07111a);border-radius:12px;padding:18px;box-shadow:0 8px 30px rgba(0,0,0,.6)}
    h1{margin:0 0 8px 0;font-size:20px;text-align:center}
    .plane{height:120px;display:flex;align-items:center;justify-content:center}
    .mult{font-size:36px;font-weight:700;text-align:center;margin:6px 0}
    .controls{display:flex;gap:8px;margin-top:12px}
    input[type=number]{flex:1;padding:8px;border-radius:8px;border:none}
    button{padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .btn-start{background:#06b6d4;color:#032}
    .btn-cash{background:#10b981;color:#032;flex:1}
    .log{margin-top:12px;font-size:13px;color:#cbd5e1;height:90px;overflow:auto}
    .bar{height:10px;background:rgba(255,255,255,.06);border-radius:6px;margin-top:8px;overflow:hidden}
    .progress{height:100%;width:0%;background:linear-gradient(90deg,#f97316,#fca5a5);transition:width .05s linear}
  </style>
</head>
<body>
  <div class="card">
    <h1>Crash â€” Ù„Ø¹Ø¨Ø© Ø§Ù„Ø·ÙŠØ§Ø±Ø© ðŸš€</h1>
    <div class="plane">
      <img id="planeImg" src="/static/plane.png" alt="plane" style="height:90px;transform-origin:center"/>
    </div>
    <div class="mult" id="mult">x1.00</div>
    <div class="bar"><div class="progress" id="progress"></div></div>
    <div style="display:flex;gap:8px;margin-top:10px;">
      <input id="betAmount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" />
      <button id="startBtn" class="btn-start">Ø§Ø¨Ø¯Ø£</button>
    </div>
    <div class="controls" style="margin-top:8px;">
      <button id="cashBtn" class="btn-cash" disabled>Cashout</button>
    </div>
    <div class="log" id="log"></div>
  </div>

  <script>
  // Ø¨Ø³ÙŠØ· ÙˆÙ…Ø­Ù…ÙˆÙ„: ÙŠÙ‚Ø±Ø£ bet_id Ù…Ù† Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙØ­Ø© (query string) Ø£Ùˆ Ù…Ù† Ø¢Ø®Ø± Ø¬Ø²Ø¡ Ù…Ù† path
  (function(){
    function qs(name){ name=name.replace(/[[]/,"\\[").replace(/[\]]/,"\\]"); var regex=new RegExp("[\\?&]"+name+"=([^&#]*)"); var results=regex.exec(location.search); return results===null?null:decodeURIComponent(results[1].replace(/\+/g," ")); }
    const urlParts = location.pathname.split('/');
    const paramId = qs('bet_id') || urlParts[urlParts.length-1] || null;
    const betId = Number(paramId);
    const startBtn=document.getElementById('startBtn');
    const cashBtn=document.getElementById('cashBtn');
    const multDisplay=document.getElementById('mult');
    const log=document.getElementById('log');
    const progress=document.getElementById('progress');
    const betInput=document.getElementById('betAmount');

    let crashMultiplier = 3.0;
    let running=false;
    let currentMult=1.0;
    let animId=null;
    let startTime=null;
    let crashed=false;

    function addLog(t){ log.innerText = t + "\n" + log.innerText; }

    async function fetchBet(){
      if(!betId){ addLog("Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„Ø±Ù‡Ø§Ù† ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·."); return null; }
      try{
        const resp = await fetch('/api/get_bet/' + betId);
        if(!resp.ok) throw new Error('no');
        const j = await resp.json();
        if(!j.ok) { addLog("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±Ù‡Ø§Ù†."); return null; }
        return j;
      }catch(e){
        addLog("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ù‡Ø§Ù†.");
        return null;
      }
    }

    function animate(){
      if(crashed) return;
      const t = Date.now();
      const dt = (t - startTime);
      currentMult = 1.0 + Math.exp(0.002 * dt / 10) - 1.0;
      if(currentMult>1000) currentMult=1000;
      multDisplay.innerText = "x" + currentMult.toFixed(2);
      const pct = Math.min((currentMult / crashMultiplier) * 100, 100);
      progress.style.width = pct + "%";
      const plane = document.getElementById('planeImg');
      if(plane) plane.style.transform = `rotate(${Math.min((currentMult-1)*8,40)}deg) translateX(${Math.min((currentMult-1)*6,50)}px)`;
      if(currentMult >= crashMultiplier){
        crashed=true; running=false; cashBtn.disabled=true;
        addLog(`ðŸ’¥ Ø§Ù†ÙØ¬Ø§Ø± Ø¹Ù†Ø¯ x${crashMultiplier.toFixed(2)} â€” Ø®Ø³Ø±Øª Ø§Ù„Ø±Ù‡Ø§Ù†.`);
        multDisplay.innerText = "BOOM!";
        fetch('/api/cashout', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({bet_id:betId, cashed_at: crashMultiplier + 1.0})});
        cancelAnimationFrame(animId);
        return;
      }
      animId = requestAnimationFrame(animate);
    }

    startBtn.addEventListener('click', async ()=>{
      if(running) return;
      const amount = Number(betInput.value);
      if(isNaN(amount) || amount<=0){ addLog("Ø¶Ø¹ Ù…Ø¨Ù„Øº ØµØ§Ù„Ø­ Ù„Ù„Ø±Ù‡Ø§Ù†."); return; }
      const bet = await fetchBet();
      if(!bet) return;
      if(bet.amount != amount){ addLog("ØªØ­Ø°ÙŠØ±: Ø§Ù„Ù…Ø¨Ù„Øº ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø®ØªÙ„Ù Ø¹Ù† Ø§Ù„Ù…Ø¯Ø®Ù„ Ù‡Ù†Ø§."); /* allow for demo */ }
      crashMultiplier = bet.crash_multiplier || 3.0;
      addLog(`Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø¯Ø£Øª â€” Ø§Ù„Ø·ÙŠØ§Ø±Ø© Ù‚Ø¯ ØªÙ†ÙØ¬Ø± Ø¹Ù†Ø¯ Ù…Ø¶Ø§Ø¹Ù Ø¹Ø´ÙˆØ§Ø¦ÙŠ.`);
      running=true; crashed=false; currentMult=1.0; startTime=Date.now(); cashBtn.disabled=false;
      animId = requestAnimationFrame(animate);
    });

    cashBtn.addEventListener('click', async ()=>{
      if(!running) return;
      running=false; cashBtn.disabled=true;
      const cashed_at = currentMult;
      addLog(`Ø¬Ø§Ø±Ù Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø³Ø­Ø¨ Ø¹Ù†Ø¯ x${cashed_at.toFixed(2)}...`);
      try{
        const resp = await fetch('/api/cashout', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({bet_id: betId, cashed_at: cashed_at})});
        const j = await resp.json();
        if(j.ok && j.result==='won'){ addLog(`âœ… ÙØ²Øª! Ø¬Ø§Ø¦Ø²Ø©: ${j.payout}`); multDisplay.innerText = "WIN x" + cashed_at.toFixed(2);}
        else addLog("Ø®Ø³Ø±Øª Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£.");
      }catch(e){ addLog("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±."); }
      cancelAnimationFrame(animId);
    });

    (async ()=>{ const b = await fetchBet(); if(b){ addLog(`Ø±Ù‡Ø§Ù† #${b.bet_id} â€” Ø§Ù„Ù…Ø¨Ù„Øº: ${b.amount}`); betInput.value = b.amount; } })();

  })();
  </script>
</body>
</html>
